<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Murimed - Gestão de Honorários</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        @media print { .no-print { display: none !important; } }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@19.0.0';
        import { createRoot } from 'https://esm.sh/react-dom@19.0.0/client';
        import htm from 'https://esm.sh/htm';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@1.34.0';

        const html = htm.bind(React.createElement);

        const MASTER_KEY = "MURIMED2025"; 

        const PRICE_TABLE = {
            Hapvida: {
                "IPSA": { "CLÍNICA MÉDICA": 143.64, "PEDIATRIA": 149.04 },
                "RIBEIRÃO PIRES": { "CLÍNICA MÉDICA": 150.50, "PEDIATRIA": 149.80, "ORTOPEDIA": 148.00, "RETAGUARDA": 165.00 },
                "MAUÁ": { "CLÍNICA MÉDICA": 141.00, "PEDIATRIA": 145.60, "RETAGUARDA": 165.00 },
                "SÃO CAETANO DO SUL": { "CLÍNICA MÉDICA": 141.00, "PEDIATRIA": 145.60 }
            },
            Murimed: {
                "IPSA": { "CLÍNICA MÉDICA": 115.50, "PEDIATRIA": 120.05 },
                "RIBEIRÃO PIRES": { "CLÍNICA MÉDICA": 100.00, "PEDIATRIA": 108.33, "ORTOPEDIA": 108.33, "RETAGUARDA": 136.12 },
                "MAUÁ": { "CLÍNICA MÉDICA": 100.00, "PEDIATRIA": 108.33, "RETAGUARDA": 136.12 },
                "SÃO CAETANO DO SUL": { "CLÍNICA MÉDICA": 100.00, "PEDIATRIA": 108.33 }
            }
        };

        const App = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [accessKeyInput, setAccessKeyInput] = useState('');
            const [loginError, setLoginError] = useState(false);
            const [entries, setEntries] = useState([]);
            const [hourlyRate, setHourlyRate] = useState(143.64);
            const [description, setDescription] = useState('');
            const [hours, setHours] = useState('');
            const [minutes, setMinutes] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [aiReport, setAiReport] = useState(null);
            const [selPlan, setSelPlan] = useState('Hapvida');
            const [selUnit, setSelUnit] = useState('IPSA');
            const [selSpecialty, setSelSpecialty] = useState('CLÍNICA MÉDICA');

            useEffect(() => {
                const isAuth = sessionStorage.getItem('murimed_session_v1') === 'true';
                if (isAuth) setIsAuthenticated(true);
            }, []);

            useEffect(() => {
                const planData = PRICE_TABLE[selPlan];
                const unitData = planData[selUnit];
                if (unitData && unitData[selSpecialty]) {
                    setHourlyRate(unitData[selSpecialty]);
                }
            }, [selPlan, selUnit, selSpecialty]);

            useEffect(() => {
                const saved = localStorage.getItem('murimed_db_v1');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.entries) setEntries(parsed.entries);
                    } catch (e) {}
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('murimed_db_v1', JSON.stringify({ entries }));
            }, [entries]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (accessKeyInput.trim().toUpperCase() === MASTER_KEY) {
                    setIsAuthenticated(true);
                    sessionStorage.setItem('murimed_session_v1', 'true');
                    setLoginError(false);
                } else {
                    setLoginError(true);
                    setAccessKeyInput('');
                    setTimeout(() => setLoginError(false), 3000);
                }
            };

            const addEntry = (e) => {
                e.preventDefault();
                if (!hours && !minutes && !description) return;
                const newEntry = {
                    id: Math.random().toString(36).substr(2, 9),
                    description: description || `${selUnit} - ${selSpecialty}`,
                    hours: parseInt(hours) || 0,
                    minutes: parseInt(minutes) || 0,
                    date: new Date().toLocaleDateString('pt-BR'),
                    plan: selPlan,
                    rate: hourlyRate
                };
                setEntries([...entries, newEntry]);
                setDescription(''); setHours(''); setMinutes('');
            };

            const stats = useMemo(() => {
                let hapTotal = 0; let muriTotal = 0; let totalMins = 0;
                entries.forEach(e => {
                    const value = ((e.hours * 60 + e.minutes) / 60) * e.rate;
                    totalMins += (e.hours * 60 + e.minutes);
                    if (e.plan === 'Hapvida') hapTotal += value;
                    else muriTotal += value;
                });
                return {
                    formattedTime: `${Math.floor(totalMins / 60)}h ${(totalMins % 60).toString().padStart(2, '0')}m`,
                    hapvida: hapTotal, murimed: muriTotal, grandTotal: hapTotal + muriTotal
                };
            }, [entries]);

            const handleAiAnalysis = async () => {
                if (entries.length === 0) return;
                setIsAnalyzing(true);
                try {
                    const ai = new GoogleGenAI({ apiKey: window.process?.env?.API_KEY || '' });
                    const summary = entries.map(e => `- [${e.plan}] ${e.description}: ${e.hours}h${e.minutes}m`).join('\n');
                    const prompt = `Analise os honorários médicos da Murimed. Total: R$ ${stats.grandTotal.toFixed(2)}. Tempo: ${stats.formattedTime}. Registros:\n${summary}\nCrie um relatório profissional resumido em Português do Brasil.`;
                    const response = await ai.models.generateContent({ model: 'gemini-3-flash-preview', contents: prompt });
                    setAiReport(response.text);
                } catch (err) {
                    setAiReport("Configure a API Key para usar a inteligência artificial.");
                } finally { setIsAnalyzing(false); }
            };

            const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

            if (!isAuthenticated) {
                return html`
                    <div class="min-h-screen flex items-center justify-center p-6 bg-slate-100">
                        <div class="max-w-md w-full bg-white p-10 rounded-[2.5rem] shadow-2xl border border-white text-center">
                            <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                                <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <h1 class="text-2xl font-black text-slate-800 tracking-tighter uppercase mb-2">Acesso Restrito</h1>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-10">Murimed Serviços Médicos</p>
                            <form onSubmit=${handleLogin} class="space-y-4">
                                <input type="password" placeholder="Digite sua senha" value=${accessKeyInput} onChange=${e => setAccessKeyInput(e.target.value)} autoFocus class="w-full bg-slate-50 border ${loginError ? 'border-red-400' : 'border-slate-200'} rounded-2xl py-4 px-6 text-center text-lg font-bold tracking-widest focus:ring-4 focus:ring-indigo-100 outline-none transition-all" />
                                ${loginError && html`<p class="text-red-500 text-[10px] font-black uppercase mt-2 animate-pulse">Senha Incorreta</p>`}
                                <button class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-indigo-700 shadow-xl transition-all uppercase text-[11px] tracking-[0.2em]">Acessar Sistema</button>
                            </form>
                        </div>
                    </div>
                `;
            }

            return html`
                <div class="min-h-screen p-4 md:p-8">
                    <div class="max-w-5xl mx-auto">
                        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4 no-print">
                            <div class="flex items-center gap-3">
                                <div class="bg-indigo-600 p-3 rounded-2xl shadow-xl shadow-indigo-100">
                                    <svg class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Murimed <span class="text-indigo-600">Serviços Médicos</span></h1>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Gestão Profissional de Honorários</p>
                                </div>
                            </div>
                            <div class="bg-white px-5 py-3 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4">
                                <div class="text-right border-r pr-4 border-slate-100">
                                    <span class="text-[10px] font-black text-slate-400 uppercase block leading-none mb-1">Taxa Atual</span>
                                    <span class="text-lg font-black text-indigo-600">${formatCurrency(hourlyRate)}</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase">Ajuste</span>
                                    <input type="number" value=${hourlyRate} onChange=${e => setHourlyRate(Number(e.target.value))} class="w-20 text-xs bg-slate-50 p-1.5 rounded font-bold text-slate-500 outline-none border border-transparent focus:border-indigo-100" />
                                </div>
                            </div>
                        </header>

                        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 no-print">
                            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm lg:col-span-2">
                                <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">Configuração da Unidade</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Plano</label>
                                        <select value=${selPlan} onChange=${e => { setSelPlan(e.target.value); setSelUnit(Object.keys(PRICE_TABLE[e.target.value])[0]); }} class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                                            <option value="Hapvida">Hapvida</option>
                                            <option value="Murimed">Murimed</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Unidade</label>
                                        <select value=${selUnit} onChange=${e => { setSelUnit(e.target.value); setSelSpecialty(Object.keys(PRICE_TABLE[selPlan][e.target.value])[0]); }} class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                                            ${Object.keys(PRICE_TABLE[selPlan]).map(u => html`<option key=${u} value=${u}>${u}</option>`)}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black text-slate-500 uppercase mb-2">Especialidade</label>
                                        <select value=${selSpecialty} onChange=${e => setSelSpecialty(e.target.value)} class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                                            ${Object.keys(PRICE_TABLE[selPlan][selUnit] || {}).map(s => html`<option key=${s} value=${s}>${s}</option>`)}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                                <form onSubmit=${addEntry} class="space-y-4">
                                    <input type="text" placeholder="Descrição do Plantão" value=${description} onChange=${e => setDescription(e.target.value)} class="w-full border border-slate-100 bg-slate-50 rounded-xl p-3 text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500" />
                                    <div class="grid grid-cols-2 gap-3">
                                        <input type="number" placeholder="Horas" value=${hours} onChange=${e => setHours(e.target.value)} class="w-full border border-slate-100 bg-slate-50 rounded-xl p-3 text-sm font-bold" />
                                        <input type="number" placeholder="Mins" value=${minutes} onChange=${e => setMinutes(e.target.value)} class="w-full border border-slate-100 bg-slate-50 rounded-xl p-3 text-sm font-bold" />
                                    </div>
                                    <button class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl text-xs uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg active:scale-95">Adicionar Registro</button>
                                </form>
                            </div>
                        </section>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="bg-white p-6 rounded-3xl border border-slate-200 border-l-4 border-l-cyan-500 shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase block mb-2">Total Hapvida</span>
                                <p class="text-2xl font-black text-slate-800">${formatCurrency(stats.hapvida)}</p>
                            </div>
                            <div class="bg-white p-6 rounded-3xl border border-slate-200 border-l-4 border-l-rose-500 shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase block mb-2">Total Murimed</span>
                                <p class="text-2xl font-black text-slate-800">${formatCurrency(stats.murimed)}</p>
                            </div>
                            <div class="bg-indigo-600 p-6 rounded-3xl text-white shadow-xl shadow-indigo-100">
                                <span class="text-[10px] font-black text-indigo-200 uppercase block mb-2">Consolidado Geral</span>
                                <p class="text-2xl font-black">${formatCurrency(stats.grandTotal)}</p>
                            </div>
                            <div class="bg-slate-800 p-6 rounded-3xl text-white shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase block mb-2">Tempo Total</span>
                                <p class="text-2xl font-black">${stats.formattedTime}</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden mb-12">
                            <div class="px-8 py-6 bg-slate-50 border-b flex flex-wrap gap-4 justify-between items-center no-print">
                                <h2 class="font-black text-slate-700 uppercase text-[10px] tracking-widest">Listagem de Honorários</h2>
                                <div class="flex gap-2">
                                    <button onClick=${handleAiAnalysis} disabled=${isAnalyzing || entries.length === 0} class="bg-indigo-600 text-white px-5 py-2.5 rounded-full text-[10px] font-black hover:scale-105 transition-all shadow-md disabled:opacity-50">
                                        ${isAnalyzing ? '...' : '✨ IA'}
                                    </button>
                                    <button onClick=${() => window.print()} class="bg-white border border-slate-200 px-5 py-2.5 rounded-full text-[10px] font-black hover:bg-slate-50 transition-all">PDF</button>
                                    <button onClick=${() => confirm('Limpar tudo?') && setEntries([])} class="bg-red-50 text-red-500 px-5 py-2.5 rounded-full text-[10px] font-black hover:bg-red-100 transition-all">LIMPAR</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                                            <th class="px-8 py-5">Convênio</th>
                                            <th class="px-8 py-5">Descrição</th>
                                            <th class="px-8 py-5">Tempo</th>
                                            <th class="px-8 py-5 text-right">Líquido</th>
                                            <th class="px-8 py-5 no-print"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${entries.length === 0 ? html`<tr><td colSpan="5" class="py-24 text-center text-slate-300 font-black uppercase text-xs tracking-widest">Nenhum registro encontrado</td></tr>` : 
                                          entries.map(e => html`
                                            <tr key=${e.id} class="hover:bg-slate-50/50 group transition-all">
                                                <td class="px-8 py-6">
                                                    <span class="text-[9px] font-black px-3 py-1.5 rounded-full uppercase ${e.plan === 'Hapvida' ? 'bg-cyan-100 text-cyan-700' : 'bg-rose-100 text-rose-700'}">${e.plan}</span>
                                                </td>
                                                <td class="px-8 py-6 font-bold text-slate-700">${e.description}</td>
                                                <td class="px-8 py-6 font-bold text-slate-500">${e.hours}h ${e.minutes}m</td>
                                                <td class="px-8 py-6 text-right font-black text-indigo-600">${formatCurrency(((e.hours * 60 + e.minutes)/60) * e.rate)}</td>
                                                <td class="px-8 py-6 text-right no-print">
                                                    <button onClick=${() => setEntries(entries.filter(x => x.id !== e.id))} class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all">Excluir</button>
                                                </td>
                                            </tr>
                                        `)}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${aiReport && html`
                            <div class="bg-slate-900 text-slate-100 rounded-[2rem] p-8 md:p-12 mb-20 shadow-2xl relative overflow-hidden border border-white/5">
                                <h4 class="text-[10px] font-black uppercase tracking-[0.5em] mb-6 text-indigo-400">Relatório Estratégico IA</h4>
                                <div class="text-slate-300 whitespace-pre-wrap leading-relaxed text-sm font-medium">${aiReport}</div>
                                <button onClick=${() => setAiReport(null)} class="mt-8 text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-white underline underline-offset-4">Fechar</button>
                            </div>
                        `}

                        <footer class="text-center pb-20 no-print">
                            <div class="h-px bg-slate-200 w-24 mx-auto mb-8"></div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Murimed Serviços Médicos • 2025</p>
                        </footer>
                    </div>
                </div>
            `;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>